# ğŸ“ Offline-First Architecture Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         UI LAYER (Presentation)                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ Transactions   â”‚  â”‚ Sync Status    â”‚  â”‚ Offline        â”‚        â”‚
â”‚  â”‚ Page          â”‚  â”‚ Indicator      â”‚  â”‚ Indicator      â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                   â”‚                   â”‚
           â”‚ Uses BLoC         â”‚ Streams          â”‚ Streams
           â–¼                   â–¼                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      BUSINESS LOGIC (BLoC)                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚              TransactionBloc                             â”‚       â”‚
â”‚  â”‚  â€¢ LoadTransactions                                      â”‚       â”‚
â”‚  â”‚  â€¢ AddTransaction                                        â”‚       â”‚
â”‚  â”‚  â€¢ UpdateTransaction                                     â”‚       â”‚
â”‚  â”‚  â€¢ DeleteTransaction                                     â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚ Calls Repository
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      DATA LAYER (Repositories)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚      OfflineFirstTransactionRepository (Wrapper)         â”‚       â”‚
â”‚  â”‚  â€¢ Detects online/offline status                         â”‚       â”‚
â”‚  â”‚  â€¢ Routes to appropriate repository                      â”‚       â”‚
â”‚  â”‚  â€¢ Handles fallback scenarios                            â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚           â”‚                                 â”‚                        â”‚
â”‚    Online â”‚                          Offlineâ”‚                        â”‚
â”‚           â–¼                                 â–¼                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ TransactionRepo     â”‚         â”‚ OfflineTransaction   â”‚          â”‚
â”‚  â”‚ Impl (Firebase)     â”‚         â”‚ Repository (SQLite)  â”‚          â”‚
â”‚  â”‚ â€¢ Firestore CRUD    â”‚         â”‚ â€¢ Local DB CRUD      â”‚          â”‚
â”‚  â”‚ â€¢ Storage Upload    â”‚         â”‚ â€¢ Pending Queue      â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚                   â”‚
                        â–¼                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      CORE SERVICES                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚              ConnectivityService                          â”‚       â”‚
â”‚  â”‚  â€¢ Monitors network status                               â”‚       â”‚
â”‚  â”‚  â€¢ Emits connection changes                              â”‚       â”‚
â”‚  â”‚  â€¢ connectivity_plus integration                         â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                       â”‚ Notifies                                     â”‚
â”‚                       â–¼                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚                  SyncService                              â”‚       â”‚
â”‚  â”‚  â€¢ Auto-syncs when online                                â”‚       â”‚
â”‚  â”‚  â€¢ Retry logic (max 3 attempts)                          â”‚       â”‚
â”‚  â”‚  â€¢ Emits sync status                                     â”‚       â”‚
â”‚  â”‚  â€¢ Manages sync queue                                    â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚ Reads/Writes
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      DATA STORAGE                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚                  LocalDatabase                            â”‚       â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚       â”‚
â”‚  â”‚  â”‚ pending_          â”‚  â”‚ sync_queue         â”‚         â”‚       â”‚
â”‚  â”‚  â”‚ transactions       â”‚  â”‚ (future use)       â”‚         â”‚       â”‚
â”‚  â”‚  â”‚ â€¢ local_id (PK)   â”‚  â”‚ â€¢ operation_type   â”‚         â”‚       â”‚
â”‚  â”‚  â”‚ â€¢ transaction dataâ”‚  â”‚ â€¢ entity_id        â”‚         â”‚       â”‚
â”‚  â”‚  â”‚ â€¢ sync_status     â”‚  â”‚ â€¢ retry_count      â”‚         â”‚       â”‚
â”‚  â”‚  â”‚ â€¢ retry_count     â”‚  â”‚ â€¢ status           â”‚         â”‚       â”‚
â”‚  â”‚  â”‚ â€¢ error_message   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚       â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                 â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚             Firebase (Cloud)                              â”‚       â”‚
â”‚  â”‚  â€¢ Firestore (transactions collection)                   â”‚       â”‚
â”‚  â”‚  â€¢ Storage (attachments)                                 â”‚       â”‚
â”‚  â”‚  â€¢ Auth (user management)                                â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”„ Data Flow Diagrams

### **Adding Transaction (Online)**

```
User Input â†’ TransactionBloc â†’ OfflineFirstTransactionRepository
                                         â”‚
                                         â”œâ”€ Check Connectivity âœ“
                                         â”‚
                                         â–¼
                                 TransactionRepositoryImpl
                                         â”‚
                                         â–¼
                                  Firebase Firestore
                                         â”‚
                                         â–¼
                                   Success âœ“
                                         â”‚
                                         â–¼
                              UI Updated (BLoC State)
```

### **Adding Transaction (Offline)**

```
User Input â†’ TransactionBloc â†’ OfflineFirstTransactionRepository
                                         â”‚
                                         â”œâ”€ Check Connectivity âœ—
                                         â”‚
                                         â–¼
                              OfflineTransactionRepository
                                         â”‚
                                         â–¼
                                  SQLite Database
                                         â”‚
                                (local_id generated)
                                         â”‚
                                         â–¼
                                Status: 'pending'
                                         â”‚
                                         â–¼
                              UI Updated (shows immediately)
                                         â”‚
                                         â–¼
                           [Waits for connection...]
```

### **Automatic Sync (When Online)**

```
     Network Restored
            â”‚
            â–¼
   ConnectivityService
     (detects change)
            â”‚
            â–¼
      SyncService
    (auto-triggered)
            â”‚
            â”œâ”€ Fetch Pending from SQLite
            â”‚
            â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ For each pending â”‚
  â”‚  transaction:    â”‚
  â”‚                  â”‚
  â”‚ 1. Upload to     â”‚
  â”‚    Firebase      â”‚
  â”‚                  â”‚
  â”‚ 2. Get Firebase  â”‚
  â”‚    ID            â”‚
  â”‚                  â”‚
  â”‚ 3. Update status â”‚
  â”‚    to 'synced'   â”‚
  â”‚                  â”‚
  â”‚ 4. Delete from   â”‚
  â”‚    local DB      â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
    Emit SyncStatus
   (UI shows progress)
            â”‚
            â–¼
      All Synced âœ“
```

### **Retry Logic Flow**

```
   Sync Attempt
        â”‚
        â–¼
    Success?
     â”Œâ”€â”€â”´â”€â”€â”
     â”‚ Yes â”‚ â†’ Delete from local DB â†’ Done âœ“
     â””â”€â”€â”€â”€â”€â”˜
     â”Œâ”€â”€â”´â”€â”€â”
     â”‚ No  â”‚
     â””â”€â”€â”¬â”€â”€â”˜
        â”‚
        â–¼
  Increment retry_count
        â”‚
        â–¼
  retry_count < 3?
     â”Œâ”€â”€â”´â”€â”€â”
     â”‚ Yes â”‚ â†’ Set status: 'pending' â†’ Wait for next sync
     â””â”€â”€â”€â”€â”€â”˜
     â”Œâ”€â”€â”´â”€â”€â”
     â”‚ No  â”‚
     â””â”€â”€â”¬â”€â”€â”˜
        â”‚
        â–¼
  Set status: 'failed'
  Store error_message
        â”‚
        â–¼
   Manual retry needed
```

## ğŸ¯ Key Design Decisions

### 1. **Optimistic UI Updates**

- Transactions appear immediately in UI
- No waiting for Firebase response
- Better user experience

### 2. **Transparent Sync**

- User doesn't need to manually sync
- Automatic background process
- Visual indicators for sync status

### 3. **Graceful Degradation**

- App works fully offline
- Falls back to local data if Firebase fails
- No crashes or errors

### 4. **Retry Strategy**

- Automatic retry with exponential backoff
- Max 3 attempts to avoid infinite loops
- Failed transactions marked for manual review

### 5. **Single Source of Truth**

- Firebase is the primary database
- Local DB is temporary storage
- Synced data is cleaned up

## ğŸ“Š State Management

### **Transaction States**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Created   â”‚ â† User creates transaction
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€ Online  â”€â”€â†’ Firebase â”€â”€â†’ Success âœ“
       â”‚
       â””â”€ Offline â”€â”€â†’ Local DB â”€â”€â†’ Status: 'pending'
                                          â”‚
                       Connection Restoredâ”‚
                                          â”‚
                                          â–¼
                                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                   â”‚ Syncing  â”‚
                                   â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                                         â”‚
                             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                             â”‚                       â”‚
                        Success                  Failure
                             â”‚                       â”‚
                             â–¼                       â–¼
                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                      â”‚  Synced   â”‚          â”‚  Retry   â”‚
                      â”‚ (deleted) â”‚          â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
                                            retry < 3?
                                                  â”‚
                                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                        â”‚                    â”‚
                                       Yes                  No
                                        â”‚                    â”‚
                                        â–¼                    â–¼
                                   'pending'           'failed'
```

## ğŸ” Security Considerations

1. **Local Database**

   - Not encrypted by default (consider adding encryption)
   - Cleared on user logout

2. **Firebase Rules**

   - User authentication required
   - Row-level security enforced

3. **Sync Process**
   - Uses authenticated user context
   - Validates permissions before sync

## ğŸš€ Performance Optimizations

1. **Database Indexes**

   - Indexed on sync_status for fast queries
   - Indexed on created_at for ordering

2. **Batch Operations**

   - Syncs multiple transactions in sequence
   - Minimizes Firebase requests

3. **Stream-based Updates**

   - Real-time UI updates
   - No polling required

4. **Lazy Loading**
   - Database initialized on first access
   - Services initialized once

---

**This architecture ensures reliable offline operation while maintaining data consistency and user experience!** ğŸ‰
